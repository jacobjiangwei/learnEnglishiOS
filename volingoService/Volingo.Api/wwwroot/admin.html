<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volingo æ•™æç®¡ç†åå°</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 24px; }
        h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
        .subtitle { color: #86868b; margin-bottom: 32px; }
        /* Tabs */
        .tab-bar {
            display: flex; gap: 0; margin-bottom: 24px;
            background: #e5e5ea; border-radius: 10px; padding: 3px;
        }
        .tab-btn {
            flex: 1; padding: 10px 16px; border: none; background: transparent;
            font-size: 15px; font-weight: 600; cursor: pointer;
            border-radius: 8px; transition: all 0.15s; color: #666;
        }
        .tab-btn.active { background: #fff; color: #1d1d1f; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .card h2 {
            font-size: 18px; font-weight: 600; margin-bottom: 16px;
            display: flex; align-items: center; gap: 8px;
        }
        .card h2 .step {
            background: #007aff; color: #fff;
            width: 28px; height: 28px; border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 700;
        }
        label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 14px; }
        select, input[type="file"] {
            width: 100%; padding: 10px 12px;
            border: 1px solid #d2d2d7; border-radius: 8px;
            font-size: 15px; background: #fff; margin-bottom: 12px;
        }
        select:focus { outline: none; border-color: #007aff; box-shadow: 0 0 0 3px rgba(0,122,255,0.15); }
        .row { display: flex; gap: 16px; }
        .row > * { flex: 1; }
        .btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 10px 20px; border: none; border-radius: 8px;
            font-size: 15px; font-weight: 600; cursor: pointer;
            transition: all 0.15s;
        }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-primary { background: #007aff; color: #fff; }
        .btn-primary:hover:not(:disabled) { background: #0062cc; }
        .btn-success { background: #34c759; color: #fff; }
        .btn-success:hover:not(:disabled) { background: #28a745; }
        .btn-danger { background: #ff3b30; color: #fff; }
        .btn-danger:hover:not(:disabled) { background: #d63027; }
        .btn-analyze { background: #8b5cf6; color: #fff; }
        .btn-analyze:hover:not(:disabled) { background: #7c3aed; }
        .btn-orange { background: #ff9500; color: #fff; }
        .btn-orange:hover:not(:disabled) { background: #e68600; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .preview-box {
            background: #fafafa; border: 1px solid #e5e5ea; border-radius: 8px;
            padding: 16px; max-height: 500px; overflow-y: auto;
            font-family: "SF Mono", Monaco, monospace; font-size: 13px;
            white-space: pre-wrap; word-break: break-all; display: none;
        }
        .status {
            padding: 12px 16px; border-radius: 8px; margin-top: 12px;
            font-size: 14px; display: none;
        }
        .status.info    { background: #e8f4fd; color: #0a84ff; display: block; }
        .status.success { background: #e8fae8; color: #248a3d; display: block; }
        .status.error   { background: #fde8e8; color: #ff3b30; display: block; }
        .status.loading { background: #fff8e1; color: #ff9500; display: block; }
        .inventory-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .inventory-table th {
            text-align: left; padding: 10px 12px;
            background: #f5f5f7; border-bottom: 2px solid #e5e5ea; font-weight: 600;
        }
        .inventory-table td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; }
        .inventory-table tr:hover td { background: #f5f5f7; }
        .badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 12px; font-weight: 600;
        }
        .badge-done { background: #e8fae8; color: #248a3d; }
        .badge-empty { background: #f0f0f0; color: #86868b; }
        .badge-ai { background: #f3e8ff; color: #8b5cf6; }
        .spinner {
            display: inline-block; width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid #fff; border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .meta { display: flex; gap: 16px; margin-top: 8px; font-size: 13px; color: #86868b; }
        .meta span { display: flex; align-items: center; gap: 4px; }
        /* Modal */
        .modal-overlay {
            display: none; position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;
        }
        .modal-overlay.active { display: flex; justify-content: center; padding: 40px 20px; }
        .modal {
            background: #fff; border-radius: 16px;
            max-width: 860px; width: 100%;
            max-height: calc(100vh - 80px); overflow-y: auto;
            padding: 32px; position: relative;
        }
        .modal-close {
            position: absolute; top: 16px; right: 16px;
            background: #f0f0f0; border: none;
            width: 32px; height: 32px; border-radius: 50%;
            font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-close:hover { background: #e0e0e0; }
        .modal h2 { font-size: 22px; margin-bottom: 20px; }
        .unit-card {
            border: 1px solid #e5e5ea; border-radius: 12px;
            padding: 20px; margin-bottom: 16px;
        }
        .unit-card h3 { font-size: 16px; font-weight: 700; margin-bottom: 12px; color: #007aff; }
        .unit-section { margin-bottom: 12px; }
        .unit-section h4 {
            font-size: 13px; font-weight: 700; color: #86868b;
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;
        }
        .tag-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag {
            display: inline-block; padding: 3px 10px; border-radius: 12px;
            font-size: 13px; background: #e8f4fd; color: #0a84ff;
        }
        .tag.vocab { background: #fff3e0; color: #ff9500; }
        .tag.grammar { background: #f3e8ff; color: #8b5cf6; }
        .tag.command { background: #e8fae8; color: #248a3d; }
        .tag.song { background: #fde8e8; color: #ff3b30; }
        .sentence-item {
            padding: 4px 0; font-size: 14px; border-bottom: 1px solid #f5f5f5;
        }
        .sentence-item:last-child { border-bottom: none; }
        .sentence-pattern { font-weight: 600; color: #1d1d1f; }
        .sentence-usage { color: #86868b; font-size: 13px; margin-left: 8px; }
        .story-box {
            background: #fafafa; border-radius: 8px; padding: 12px;
            font-size: 14px; color: #333;
        }
        /* Glossary table */
        .glossary-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 8px; }
        .glossary-table th {
            text-align: left; padding: 6px 8px; background: #f5f5f7;
            border-bottom: 2px solid #e5e5ea; font-size: 12px; font-weight: 600;
        }
        .glossary-table td { padding: 4px 8px; border-bottom: 1px solid #f0f0f0; }
        /* Question generation */
        .batch-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .batch-card {
            border: 2px solid #e5e5ea; border-radius: 10px; padding: 14px;
            cursor: pointer; transition: all 0.15s;
        }
        .batch-card:hover { border-color: #007aff; background: #f0f7ff; }
        .batch-card.selected { border-color: #007aff; background: #e8f4fd; }
        .batch-card.done { border-color: #34c759; background: #e8fae8; }
        .batch-card h4 { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
        .batch-card p { font-size: 12px; color: #86868b; margin: 0; }
        .batch-card .batch-count { font-size: 11px; color: #007aff; font-weight: 600; margin-top: 4px; }
        .question-preview {
            background: #1d1d1f; color: #f5f5f7; border-radius: 10px;
            padding: 16px; max-height: 600px; overflow-y: auto;
            font-family: "SF Mono", Monaco, monospace; font-size: 12px;
            white-space: pre-wrap; word-break: break-all; margin: 12px 0;
        }
        .question-stats {
            display: flex; gap: 12px; flex-wrap: wrap; margin: 12px 0;
        }
        .question-stats .stat {
            background: #f5f5f7; border-radius: 8px; padding: 8px 14px;
            font-size: 13px; font-weight: 600;
        }
        .question-stats .stat .num { font-size: 20px; color: #007aff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š Volingo æ•™æç®¡ç†åå°</h1>
        <p class="subtitle">æ•™æå¯¼å…¥ Â· AI åˆ†æ Â· æ™ºèƒ½å‡ºé¢˜ Â· é¢˜åº“ç®¡ç†</p>

        <!-- Tab bar -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('import')">ğŸ“„ æ•™æå¯¼å…¥</button>
            <button class="tab-btn" onclick="switchTab('generate')">ğŸ¤– AI å‡ºé¢˜</button>
        </div>

        <!-- ==================== TAB: IMPORT ==================== -->
        <div class="tab-content active" id="tab-import">

        <!-- Step 1: Select textbook -->
        <div class="card">
            <h2><span class="step">1</span> é€‰æ‹©æ•™æ</h2>
            <div class="row">
                <div>
                    <label>æ•™æç‰ˆæœ¬</label>
                    <select id="seriesSelect" onchange="onSeriesChange()">
                        <option value="">â€” é€‰æ‹©æ•™æç‰ˆæœ¬ â€”</option>
                    </select>
                </div>
                <div>
                    <label>å†Œæ¬¡</label>
                    <select id="volumeSelect" disabled>
                        <option value="">â€” å…ˆé€‰æ•™æç‰ˆæœ¬ â€”</option>
                    </select>
                </div>
            </div>
            <div class="meta" id="selectionMeta" style="display:none">
                <span>ğŸ“ ID: <strong id="previewId"></strong></span>
                <span>ğŸ“– <span id="previewDisplay"></span></span>
            </div>
        </div>

        <!-- Step 2: Upload PDF -->
        <div class="card">
            <h2><span class="step">2</span> ä¸Šä¼  PDF å¹¶æå–</h2>
            <input type="file" id="pdfFile" accept=".pdf">
            <button class="btn btn-primary" id="extractBtn" onclick="extractPdf()" disabled>
                ğŸ” æå–æ–‡æœ¬
            </button>
            <div class="status" id="extractStatus"></div>
        </div>

        <!-- Step 3: Preview -->
        <div class="card" id="previewCard" style="display:none">
            <h2><span class="step">3</span> é¢„è§ˆæå–ç»“æœ</h2>
            <div class="meta" id="extractMeta">
                <span>ğŸ“„ é¡µæ•°: <strong id="metaPages">0</strong></span>
                <span>ğŸ“ å­—ç¬¦: <strong id="metaChars">0</strong></span>
            </div>
            <div class="preview-box" id="previewContent" style="display:block; margin-top:12px"></div>
            <div style="margin-top: 16px; display: flex; gap: 12px;">
                <button class="btn btn-success" id="saveBtn" onclick="saveToDb()">
                    âœ… ç¡®è®¤å­˜å…¥ Cosmos DB
                </button>
                <button class="btn btn-danger" onclick="clearPreview()">
                    âŒ æ”¾å¼ƒ
                </button>
            </div>
            <div class="status" id="saveStatus"></div>
        </div>

        <!-- Inventory -->
        <div class="card">
            <h2>ğŸ“Š å·²å…¥åº“æ–‡æ¡£</h2>
            <button class="btn btn-primary btn-sm" onclick="loadInventory()" style="margin-bottom: 12px;">
                ğŸ”„ åˆ·æ–°
            </button>
            <div id="inventoryContent">
                <p style="color: #86868b; font-size: 14px;">ç‚¹å‡»åˆ·æ–°æŸ¥çœ‹å·²å…¥åº“æ–‡æ¡£</p>
            </div>
        </div>

        <!-- Analysis Modal -->
        </div><!-- end tab-import -->

        <!-- ==================== TAB: GENERATE ==================== -->
        <div class="tab-content" id="tab-generate">

            <!-- Step G1: Select document -->
            <div class="card">
                <h2><span class="step">1</span> é€‰æ‹©å·²åˆ†æçš„æ•™æ</h2>
                <select id="genDocSelect" onchange="onGenDocChange()">
                    <option value="">â€” é€‰æ‹©æ•™ææ–‡æ¡£ â€”</option>
                </select>
                <div id="genDocInfo" style="display:none" class="meta"></div>
            </div>

            <!-- Step G2: Select unit -->
            <div class="card" id="genUnitCard" style="display:none">
                <h2><span class="step">2</span> é€‰æ‹©å•å…ƒ</h2>
                <select id="genUnitSelect" onchange="onGenUnitChange()">
                    <option value="">â€” é€‰æ‹©å•å…ƒ â€”</option>
                </select>
                <div id="genUnitInfo" style="display:none">
                    <div class="meta" style="margin-bottom:8px">
                        <span>ğŸ“ è¯æ±‡: <strong id="genUnitVocab">0</strong> ä¸ª</span>
                        <span>ğŸ’¬ å¥å‹: <strong id="genUnitPatterns">0</strong> æ¡</span>
                        <span>ğŸ“ è¯­æ³•: <strong id="genUnitGrammar">0</strong> ä¸ª</span>
                    </div>
                    <!-- Unit detail preview: what AI will see -->
                    <div id="genUnitDetail" style="margin-top:12px;background:#f9f9fb;border:1px solid #e5e5ea;border-radius:10px;padding:16px;font-size:13px;max-height:400px;overflow-y:auto;">
                    </div>
                </div>
            </div>

            <!-- Step G3: Select batch & generate -->
            <div class="card" id="genBatchCard" style="display:none">
                <h2><span class="step">3</span> é€‰æ‹©å‡ºé¢˜æ‰¹æ¬¡</h2>
                <p style="font-size:13px;color:#86868b;margin-bottom:12px;">
                    æ¯ä¸ªæ‰¹æ¬¡ç”Ÿæˆ 2~3 ç§ç›¸å…³é¢˜å‹ã€‚å¯é€æ‰¹ç”Ÿæˆã€å®¡æ ¸ã€å…¥åº“ã€‚
                </p>
                <div class="batch-grid">
                    <div class="batch-card" data-batch="0" onclick="selectBatch(0)">
                        <h4>ğŸ“ Batch 1: è¯æ±‡åŸºç¡€</h4>
                        <p>vocabulary + cloze</p>
                        <div class="batch-count">è¯æ±‡ Ã—15 + å¡«ç©º Ã—10 = 25 é¢˜</div>
                    </div>
                    <div class="batch-card" data-batch="1" onclick="selectBatch(1)">
                        <h4>ğŸ“ Batch 2: è¯­æ³•é€‰æ‹©</h4>
                        <p>grammar + MCQ + errorCorrection</p>
                        <div class="batch-count">è¯­æ³• Ã—8 + é€‰æ‹© Ã—10 + çº é”™ Ã—5 = 23 é¢˜</div>
                    </div>
                    <div class="batch-card" data-batch="2" onclick="selectBatch(2)">
                        <h4>âœï¸ Batch 3: äº§å‡ºå‹</h4>
                        <p>translation + rewriting + ordering</p>
                        <div class="batch-count">ç¿»è¯‘ Ã—6 + æ”¹å†™ Ã—5 + æ’åº Ã—5 = 16 é¢˜</div>
                    </div>
                    <div class="batch-card" data-batch="3" onclick="selectBatch(3)">
                        <h4>ğŸ“– Batch 4: ç¯‡ç« å‹</h4>
                        <p>reading + writing</p>
                        <div class="batch-count">é˜…è¯» Ã—3 ç¯‡ + å†™ä½œ Ã—3 = 6 é¢˜</div>
                    </div>
                    <div class="batch-card" data-batch="4" onclick="selectBatch(4)">
                        <h4>ğŸ§ Batch 5: å¬è¯´å‹</h4>
                        <p>listening + speaking</p>
                        <div class="batch-count">å¬åŠ› Ã—6 + å£è¯­ Ã—6 = 12 é¢˜</div>
                    </div>
                </div>
                <button class="btn btn-orange" id="generateBtn" onclick="generateQuestions()" disabled>
                    ğŸ¤– ç”Ÿæˆé¢˜ç›®
                </button>
                <div class="status" id="genStatus"></div>
            </div>

            <!-- Full-book generation -->
            <div class="card" id="genFullBookCard" style="display:none">
                <h2>ğŸ“š æ•´ä¹¦ä¸€é”®å‡ºé¢˜</h2>
                <p style="font-size:13px;color:#86868b;margin-bottom:12px;">
                    è‡ªåŠ¨éå†æ‰€æœ‰å•å…ƒ Ã— 5 ä¸ª Batchï¼Œé€ä¸€è°ƒç”¨ GPT-4o ç”Ÿæˆã€‚å®Œæˆåç»Ÿä¸€å±•ç¤ºå®¡æ ¸ã€‚
                </p>
                <div id="fullBookProgress" style="display:none;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px;">
                        <span id="fullBookProgressText">å‡†å¤‡ä¸­â€¦</span>
                        <span id="fullBookProgressCount">0/0</span>
                    </div>
                    <div style="background:#e5e5ea;border-radius:4px;height:8px;overflow:hidden;">
                        <div id="fullBookProgressBar" style="background:#007aff;height:100%;width:0%;transition:width 0.3s;border-radius:4px;"></div>
                    </div>
                    <div id="fullBookLog" style="margin-top:8px;font-size:12px;color:#86868b;max-height:150px;overflow-y:auto;font-family:monospace;"></div>
                </div>
                <div style="display:flex;gap:12px;">
                    <button class="btn btn-analyze" id="fullBookBtn" onclick="generateFullBook()">
                        ğŸ“š æ•´ä¹¦å‡ºé¢˜
                    </button>
                    <button class="btn btn-danger btn-sm" id="fullBookCancelBtn" onclick="cancelFullBook()" style="display:none">
                        â¹ åœæ­¢
                    </button>
                </div>
                <div class="status" id="fullBookStatus"></div>
            </div>

            <!-- Step G4: Review & commit -->
            <div class="card" id="genResultCard" style="display:none">
                <h2><span class="step">4</span> å®¡æ ¸é¢˜ç›® & ç¡®è®¤å…¥åº“</h2>
                <div class="question-stats" id="genStats"></div>
                <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
                    <button class="btn btn-sm btn-primary" onclick="toggleJsonView()">
                        ğŸ“‹ å±•å¼€/æ”¶èµ· JSON
                    </button>
                    <button class="btn btn-sm" id="evalBtn" onclick="evalQuestions()" style="background:#8b5cf6;color:#fff">
                        ğŸ” AI è´¨æ£€
                    </button>
                    <button class="btn btn-sm" onclick="toggleAllQuestions(true)" style="background:#34c759;color:#fff">
                        âœ… å…¨é€‰
                    </button>
                    <button class="btn btn-sm" onclick="toggleAllQuestions(false)" style="background:#ff9500;color:#fff">
                        â˜ å…¨ä¸é€‰
                    </button>
                </div>
                <div class="status" id="evalStatus"></div>
                <div class="question-preview" id="genJsonPreview" style="display:none"></div>

                <!-- Per-question visual cards with checkboxes -->
                <div id="genQuestionCards" style="margin:12px 0;max-height:500px;overflow-y:auto;"></div>

                <div style="display:flex;gap:12px;margin-top:16px;align-items:center;">
                    <button class="btn btn-success" id="commitBtn" onclick="commitQuestions()">
                        âœ… ç¡®è®¤å…¥åº“é¢˜åº“
                    </button>
                    <span id="commitCount" style="font-size:13px;color:#86868b;"></span>
                    <button class="btn btn-danger" onclick="discardQuestions()">
                        âŒ ä¸¢å¼ƒ
                    </button>
                </div>
                <div class="status" id="commitStatus"></div>
            </div>

        </div><!-- end tab-generate -->

        <!-- Analysis Modal -->
        <div class="modal-overlay" id="analysisModal">
            <div class="modal">
                <button class="modal-close" onclick="closeAnalysisModal()">âœ•</button>
                <h2 id="modalTitle">ğŸ“– çŸ¥è¯†ç‚¹åˆ†æ</h2>
                <div id="modalContent"></div>
            </div>
        </div>
    </div>

    <script>
        const API = "/api/v1/admin";
        let textbooks = [];
        let extractedContent = "";
        let extractedPages = 0;

        // â”€â”€ Init â”€â”€
        async function init() {
            const resp = await fetch(`${API}/textbooks`);
            textbooks = await resp.json();
            const sel = document.getElementById("seriesSelect");

            const groups = {};
            textbooks.forEach(t => {
                const parts = t.displayName.split("Â·");
                const group = parts.length > 1 ? parts[0] : "å…¶ä»–";
                if (!groups[group]) groups[group] = [];
                groups[group].push(t);
            });

            for (const [group, items] of Object.entries(groups)) {
                const optgroup = document.createElement("optgroup");
                optgroup.label = group;
                items.forEach(t => {
                    const opt = document.createElement("option");
                    opt.value = t.seriesCode;
                    opt.textContent = t.displayName;
                    optgroup.appendChild(opt);
                });
                sel.appendChild(optgroup);
            }

            // Auto-refresh inventory on page load
            loadInventory();
        }

        async function onSeriesChange() {
            const code = document.getElementById("seriesSelect").value;
            const volSel = document.getElementById("volumeSelect");
            volSel.innerHTML = "";

            if (!code) {
                volSel.disabled = true;
                volSel.innerHTML = '<option value="">â€” å…ˆé€‰æ•™æç‰ˆæœ¬ â€”</option>';
                updatePreviewId();
                return;
            }

            const tb = textbooks.find(t => t.seriesCode === code);
            if (!tb.isGradeSync) {
                volSel.disabled = true;
                volSel.innerHTML = '<option value="">ï¼ˆæ— éœ€é€‰æ‹©å†Œæ¬¡ï¼‰</option>';
                updatePreviewId();
                updateExtractBtn();
                return;
            }

            const resp = await fetch(`${API}/textbooks/${code}/volumes`);
            const volumes = await resp.json();

            volSel.disabled = false;
            volSel.innerHTML = '<option value="">â€” é€‰æ‹©å†Œæ¬¡ â€”</option>';
            volumes.forEach(v => {
                const opt = document.createElement("option");
                opt.value = v.volume;
                opt.textContent = v.display;
                volSel.appendChild(opt);
            });

            volSel.onchange = () => { updatePreviewId(); updateExtractBtn(); };
            updatePreviewId();
            updateExtractBtn();
        }

        function updatePreviewId() {
            const code = document.getElementById("seriesSelect").value;
            const vol = document.getElementById("volumeSelect").value;
            const meta = document.getElementById("selectionMeta");

            if (!code) { meta.style.display = "none"; return; }

            const tb = textbooks.find(t => t.seriesCode === code);
            let id = code;
            if (tb.isGradeSync && vol) {
                id = `${code}-${vol}`;
            } else if (tb.isGradeSync && !vol) {
                meta.style.display = "none";
                return;
            }

            document.getElementById("previewId").textContent = id;
            document.getElementById("previewDisplay").textContent =
                tb.displayName + (vol ? ` Â· ${document.getElementById("volumeSelect").selectedOptions[0]?.text || ""}` : "");
            meta.style.display = "flex";
        }

        function updateExtractBtn() {
            const code = document.getElementById("seriesSelect").value;
            const vol = document.getElementById("volumeSelect").value;
            const file = document.getElementById("pdfFile").files[0];
            const tb = textbooks.find(t => t.seriesCode === code);
            const ready = code && file && (!tb?.isGradeSync || vol);
            document.getElementById("extractBtn").disabled = !ready;
        }

        document.getElementById("pdfFile").addEventListener("change", updateExtractBtn);

        // â”€â”€ Extract â”€â”€
        async function extractPdf() {
            const file = document.getElementById("pdfFile").files[0];
            if (!file) return;

            const btn = document.getElementById("extractBtn");
            const status = document.getElementById("extractStatus");

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> æå–ä¸­â€¦';
            status.className = "status loading";
            status.textContent = `æ­£åœ¨ä¸Šä¼  ${file.name} (${(file.size / 1024 / 1024).toFixed(1)} MB) å¹¶è°ƒç”¨ Azure Doc Intelligenceâ€¦`;

            const formData = new FormData();
            formData.append("file", file);

            try {
                const resp = await fetch(`${API}/extract`, { method: "POST", body: formData });
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || "æå–å¤±è´¥");
                }
                const data = await resp.json();

                extractedContent = data.content;
                extractedPages = data.totalPages;

                document.getElementById("previewCard").style.display = "block";
                document.getElementById("previewContent").textContent = data.content;
                document.getElementById("metaPages").textContent = data.totalPages;
                document.getElementById("metaChars").textContent = data.charCount.toLocaleString();

                status.className = "status success";
                status.textContent = `âœ… æå–å®Œæˆ: ${data.totalPages} é¡µ, ${data.charCount.toLocaleString()} å­—ç¬¦`;
            } catch (e) {
                status.className = "status error";
                status.textContent = `âŒ ${e.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = "ğŸ” æå–æ–‡æœ¬";
                updateExtractBtn();
            }
        }

        // â”€â”€ Save â”€â”€
        async function saveToDb() {
            const code = document.getElementById("seriesSelect").value;
            const vol = document.getElementById("volumeSelect").value;
            const btn = document.getElementById("saveBtn");
            const status = document.getElementById("saveStatus");

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> ä¿å­˜ä¸­â€¦';

            try {
                const resp = await fetch(`${API}/save`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        seriesCode: code,
                        volume: vol || null,
                        rawContent: extractedContent,
                        totalPages: extractedPages,
                    }),
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || "ä¿å­˜å¤±è´¥");
                }
                const data = await resp.json();

                status.className = "status success";
                status.textContent = `âœ… å·²ä¿å­˜: ${data.id} (${data.displayName}), ${data.totalPages} é¡µ, ${data.charCount.toLocaleString()} å­—ç¬¦`;
                loadInventory();
            } catch (e) {
                status.className = "status error";
                status.textContent = `âŒ ${e.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = "âœ… ç¡®è®¤å­˜å…¥ Cosmos DB";
            }
        }

        function clearPreview() {
            document.getElementById("previewCard").style.display = "none";
            extractedContent = "";
            extractedPages = 0;
        }

        // â”€â”€ Inventory â”€â”€
        async function loadInventory() {
            const container = document.getElementById("inventoryContent");
            container.innerHTML = '<p style="color: #86868b;">åŠ è½½ä¸­â€¦</p>';

            try {
                const resp = await fetch(`${API}/documents`);
                const docs = await resp.json();

                if (docs.length === 0) {
                    container.innerHTML = '<p style="color: #86868b;">æš‚æ— å·²å…¥åº“æ–‡æ¡£</p>';
                    return;
                }

                let html = `<table class="inventory-table">
                    <thead><tr>
                        <th>ID</th><th>æ•™æ</th><th>å†Œæ¬¡</th><th>é¡µæ•°</th><th>AI åˆ†æ</th><th>æ›´æ–°æ—¶é—´</th><th>æ“ä½œ</th>
                    </tr></thead><tbody>`;

                docs.sort((a, b) => a.id.localeCompare(b.id));
                docs.forEach(doc => {
                    const updated = doc.updatedAt ? new Date(doc.updatedAt).toLocaleString("zh-CN") : "-";
                    const hasAI = doc.hasAnalysis;
                    const aiBadge = hasAI
                        ? '<span class="badge badge-ai">âœ… å·²åˆ†æ</span>'
                        : '<span class="badge badge-empty">æœªåˆ†æ</span>';
                    html += `<tr>
                        <td><code>${doc.id}</code></td>
                        <td>${doc.displayName || doc.textbook}</td>
                        <td>${doc.volume || "-"}</td>
                        <td>${doc.totalPages || 0}</td>
                        <td>${aiBadge}</td>
                        <td>${updated}</td>
                        <td style="display:flex;gap:6px;flex-wrap:wrap;">
                            <button class="btn btn-analyze btn-sm" onclick="analyzeDoc('${doc.id}','${doc.textbook}', this)">
                                ğŸ¤– ${hasAI ? 'é‡æ–°åˆ†æ' : 'AI åˆ†æ'}
                            </button>
                            ${hasAI ? `<button class="btn btn-primary btn-sm" onclick="viewAnalysis('${doc.id}','${doc.textbook}')">ğŸ“– æŸ¥çœ‹</button>` : ''}
                            <button class="btn btn-danger btn-sm" onclick="deleteDoc('${doc.id}','${doc.textbook}')">åˆ é™¤</button>
                        </td>
                    </tr>`;
                });
                html += "</tbody></table>";
                html += `<p style="color: #86868b; margin-top:8px; font-size:13px;">å…± ${docs.length} æ¡è®°å½•</p>`;
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = `<p style="color: #ff3b30;">åŠ è½½å¤±è´¥: ${e.message}</p>`;
            }
        }

        async function deleteDoc(id, textbook) {
            if (!confirm(`ç¡®è®¤åˆ é™¤ ${id}ï¼Ÿ`)) return;
            try {
                const resp = await fetch(`${API}/documents/${id}?textbook=${encodeURIComponent(textbook)}`, { method: "DELETE" });
                if (resp.ok) loadInventory();
            } catch (e) {
                alert("åˆ é™¤å¤±è´¥: " + e.message);
            }
        }

        // â”€â”€ AI Analysis â”€â”€
        async function analyzeDoc(id, textbook, btn) {
            if (!confirm(`å¯¹ ${id} è¿è¡Œ GPT-4o åˆ†æï¼Ÿ\nï¼ˆå¯èƒ½éœ€è¦ 30-60 ç§’ï¼‰`)) return;

            const origText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="border-top-color:#fff"></span> åˆ†æä¸­â€¦';

            try {
                const resp = await fetch(`${API}/analyze/${id}?textbook=${encodeURIComponent(textbook)}`, {
                    method: "POST",
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || "åˆ†æå¤±è´¥");
                }
                const data = await resp.json();
                alert(`âœ… åˆ†æå®Œæˆï¼å…±æå– ${data.unitCount} ä¸ªå•å…ƒçš„çŸ¥è¯†ç‚¹ã€‚`);
                loadInventory();
                showAnalysis(data.analysis, data.displayName);
            } catch (e) {
                alert(`âŒ åˆ†æå¤±è´¥: ${e.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = origText;
            }
        }

        async function viewAnalysis(id, textbook) {
            try {
                const resp = await fetch(`${API}/documents/${id}/analysis?textbook=${encodeURIComponent(textbook)}`);
                const data = await resp.json();
                if (!data.hasAnalysis) {
                    alert("è¯¥æ–‡æ¡£å°šæœªè¿›è¡Œ AI åˆ†æ");
                    return;
                }
                showAnalysis(data.analysis, data.displayName);
            } catch (e) {
                alert("åŠ è½½åˆ†æç»“æœå¤±è´¥: " + e.message);
            }
        }

        function showAnalysis(analysis, displayName) {
            const modal = document.getElementById("analysisModal");
            const title = document.getElementById("modalTitle");
            const content = document.getElementById("modalContent");

            title.textContent = `ğŸ“– ${displayName} â€” çŸ¥è¯†ç‚¹åˆ†æ`;

            let html = "";

            // Book info
            const info = analysis.bookInfo;
            if (info) {
                html += `<div style="margin-bottom:20px;padding:12px;background:#f5f5f7;border-radius:8px;font-size:14px;">
                    <strong>${info.title || ""}</strong><br>
                    å‡ºç‰ˆç¤¾: ${info.publisher || ""} Â· ${info.grade || ""}${info.semester || ""}
                    ${info.startingPoint ? ` Â· ${info.startingPoint}` : ""}
                    ${info.characters?.length ? `<br>è§’è‰²: ${info.characters.join(", ")}` : ""}
                </div>`;
            }

            // Units
            const units = analysis.units || [];
            units.forEach(unit => {
                html += `<div class="unit-card">`;
                html += `<h3>${unit.unitNumber === 0 ? "Starter" : `Unit ${unit.unitNumber}`}: ${unit.unitTitle || ""}</h3>`;
                if (unit.topic) {
                    html += `<div style="color:#86868b;font-size:14px;margin-bottom:12px;">ä¸»é¢˜: ${unit.topic}</div>`;
                }

                // Vocabulary
                if (unit.vocabulary?.length) {
                    html += `<div class="unit-section"><h4>ğŸ“ ç”Ÿè¯ (${unit.vocabulary.length})</h4><div class="tag-list">`;
                    unit.vocabulary.forEach(v => {
                        html += `<span class="tag vocab" title="${v.type || ''}">${v.word} <small>${v.meaning}</small></span>`;
                    });
                    html += `</div></div>`;
                }

                // Sentence patterns
                if (unit.sentencePatterns?.length) {
                    html += `<div class="unit-section"><h4>ğŸ’¬ æ ¸å¿ƒå¥å‹</h4>`;
                    unit.sentencePatterns.forEach(s => {
                        html += `<div class="sentence-item">
                            <span class="sentence-pattern">${s.pattern || s}</span>
                            ${s.usage ? `<span class="sentence-usage">â€” ${s.usage}</span>` : ""}
                        </div>`;
                    });
                    html += `</div>`;
                }

                // Grammar
                if (unit.grammar?.length) {
                    html += `<div class="unit-section"><h4>ğŸ“ è¯­æ³•è¦ç‚¹</h4><div class="tag-list">`;
                    unit.grammar.forEach(g => {
                        html += `<span class="tag grammar">${g}</span>`;
                    });
                    html += `</div></div>`;
                }

                // Songs
                if (unit.songs?.length) {
                    html += `<div class="unit-section"><h4>ğŸµ æ­Œæ›²/æ­Œè°£</h4><div class="tag-list">`;
                    unit.songs.forEach(s => {
                        html += `<span class="tag song">${s.type === "song" ? "ğŸ¶" : "ğŸ—£ï¸"} ${s.title}${s.firstLine ? ` â€” "${s.firstLine}"` : ""}</span>`;
                    });
                    html += `</div></div>`;
                }

                // Commands
                if (unit.commands?.length) {
                    html += `<div class="unit-section"><h4>ğŸ¯ è¯¾å ‚æŒ‡ä»¤</h4><div class="tag-list">`;
                    unit.commands.forEach(c => {
                        html += `<span class="tag command">${c}</span>`;
                    });
                    html += `</div></div>`;
                }

                // Story
                if (unit.storySummary) {
                    html += `<div class="unit-section"><h4>ğŸ“– Story Time</h4>
                        <div class="story-box">${unit.storyTitle ? `<strong>${unit.storyTitle}</strong><br>` : ""}${unit.storySummary}</div>
                    </div>`;
                }

                html += `</div>`;
            });

            // Vocabulary Glossary
            const glossary = analysis.vocabularyGlossary || [];
            if (glossary.length) {
                html += `<div class="unit-card">
                    <h3>ğŸ“˜ è¯æ±‡æ€»è¡¨ (${glossary.length} è¯)</h3>
                    <table class="glossary-table">
                    <thead><tr><th>å•è¯</th><th>é‡Šä¹‰</th><th>è¯æ€§</th><th>é¦–ç°å•å…ƒ</th></tr></thead>
                    <tbody>`;
                glossary.forEach(g => {
                    html += `<tr><td><strong>${g.word}</strong></td><td>${g.meaning}</td><td>${g.type || ""}</td><td>${g.unitFirst ?? ""}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            }

            content.innerHTML = html;
            modal.classList.add("active");
            document.body.style.overflow = "hidden";
        }

        function closeAnalysisModal() {
            document.getElementById("analysisModal").classList.remove("active");
            document.body.style.overflow = "";
        }
        document.getElementById("analysisModal").addEventListener("click", (e) => {
            if (e.target === e.currentTarget) closeAnalysisModal();
        });

        // Init
        init();

        // ============================
        // Tab switching
        // ============================
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach((b, i) => {
                b.classList.toggle('active', (tab === 'import' && i === 0) || (tab === 'generate' && i === 1));
            });
            document.getElementById('tab-import').classList.toggle('active', tab === 'import');
            document.getElementById('tab-generate').classList.toggle('active', tab === 'generate');
            if (tab === 'generate') loadGenDocList();
        }

        // ============================
        // Question Generation
        // ============================
        let genDocs = [];          // analyzed documents
        let genSelectedDoc = null; // currently selected doc full object
        let genSelectedUnit = null;
        let genSelectedBatch = null;
        let genPendingQuestions = []; // questions waiting for commit

        const BATCH_NAMES = [
            'VocabCloze', 'GrammarMcqError', 'TransRewriteOrder',
            'ReadingWriting', 'ListeningSpeaking'
        ];

        async function loadGenDocList() {
            const sel = document.getElementById('genDocSelect');
            sel.innerHTML = '<option value="">â€” åŠ è½½ä¸­â€¦ â€”</option>';
            try {
                const resp = await fetch(`${API}/documents`);
                const docs = await resp.json();
                genDocs = docs.filter(d => d.hasAnalysis);
                sel.innerHTML = '<option value="">â€” é€‰æ‹©æ•™ææ–‡æ¡£ â€”</option>';
                genDocs.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.id;
                    opt.textContent = `${d.displayName || d.id}`;
                    opt.dataset.textbook = d.textbook;
                    sel.appendChild(opt);
                });
            } catch (e) {
                sel.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }

        async function onGenDocChange() {
            const sel = document.getElementById('genDocSelect');
            const docId = sel.value;
            const info = document.getElementById('genDocInfo');
            const unitCard = document.getElementById('genUnitCard');
            const batchCard = document.getElementById('genBatchCard');
            const resultCard = document.getElementById('genResultCard');

            unitCard.style.display = 'none';
            batchCard.style.display = 'none';
            resultCard.style.display = 'none';
            document.getElementById('genFullBookCard').style.display = 'none';
            genSelectedDoc = null;
            genSelectedUnit = null;
            genSelectedBatch = null;
            genPendingQuestions = [];

            if (!docId) { info.style.display = 'none'; return; }

            const docMeta = genDocs.find(d => d.id === docId);
            info.style.display = 'flex';
            info.innerHTML = `<span>ğŸ“ ID: <strong>${docId}</strong></span>
                              <span>ğŸ“– ${docMeta?.displayName || docId}</span>`;

            // Fetch full document with analysis
            try {
                const resp = await fetch(`${API}/documents/${docId}/analysis?textbook=${encodeURIComponent(docMeta.textbook)}`);
                const data = await resp.json();
                if (!data.hasAnalysis) {
                    info.innerHTML += '<span style="color:#ff3b30">âŒ æœªåˆ†æ</span>';
                    return;
                }
                genSelectedDoc = { id: docId, textbook: docMeta.textbook, displayName: data.displayName, analysis: data.analysis };

                // Populate unit selector
                const unitSel = document.getElementById('genUnitSelect');
                unitSel.innerHTML = '<option value="">â€” é€‰æ‹©å•å…ƒ â€”</option>';
                data.analysis.units.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.unitNumber;
                    opt.textContent = `${u.unitNumber === 0 ? 'Starter' : 'Unit ' + u.unitNumber}: ${u.unitTitle || ''} (è¯æ±‡${u.vocabulary?.length || 0})`;
                    unitSel.appendChild(opt);
                });
                unitCard.style.display = 'block';

                // Show full-book card
                document.getElementById('genFullBookCard').style.display = 'block';
            } catch (e) {
                info.innerHTML += `<span style="color:#ff3b30">åŠ è½½å¤±è´¥: ${e.message}</span>`;
            }
        }

        function onGenUnitChange() {
            const unitNum = parseInt(document.getElementById('genUnitSelect').value);
            const unitInfo = document.getElementById('genUnitInfo');
            const batchCard = document.getElementById('genBatchCard');
            const resultCard = document.getElementById('genResultCard');
            resultCard.style.display = 'none';
            genPendingQuestions = [];

            if (isNaN(unitNum) || !genSelectedDoc) {
                unitInfo.style.display = 'none';
                batchCard.style.display = 'none';
                return;
            }

            const unit = genSelectedDoc.analysis.units.find(u => u.unitNumber === unitNum);
            genSelectedUnit = unit;

            document.getElementById('genUnitVocab').textContent = unit.vocabulary?.length || 0;
            document.getElementById('genUnitPatterns').textContent = unit.sentencePatterns?.length || 0;
            document.getElementById('genUnitGrammar').textContent = unit.grammar?.length || 0;
            unitInfo.style.display = 'block';

            // Render unit detail (what AI will see)
            renderUnitDetail(unit);

            // Reset batch selection
            document.querySelectorAll('.batch-card').forEach(c => c.classList.remove('selected', 'done'));
            genSelectedBatch = null;
            document.getElementById('generateBtn').disabled = true;
            batchCard.style.display = 'block';
        }

        function renderUnitDetail(unit) {
            const el = document.getElementById('genUnitDetail');
            let html = `<div style="font-weight:700;font-size:14px;margin-bottom:8px;color:#007aff">
                ğŸ“‹ AI å°†çœ‹åˆ°çš„å•å…ƒç´ æï¼ˆç”¨äºå‡ºé¢˜ï¼‰</div>`;

            if (unit.topic) {
                html += `<div style="margin-bottom:8px"><strong>ä¸»é¢˜:</strong> ${unit.topic}</div>`;
            }

            // Vocabulary
            if (unit.vocabulary?.length) {
                html += `<div style="margin-bottom:10px"><strong>ğŸ“ è¯æ±‡ (${unit.vocabulary.length}):</strong><div class="tag-list" style="margin-top:4px">`;
                unit.vocabulary.forEach(v => {
                    html += `<span class="tag vocab">${v.word} <small>${v.meaning}</small>${v.type ? ' <small style="color:#999">[' + v.type + ']</small>' : ''}</span>`;
                });
                html += `</div></div>`;
            }

            // Sentence patterns
            if (unit.sentencePatterns?.length) {
                html += `<div style="margin-bottom:10px"><strong>ğŸ’¬ å¥å‹:</strong>`;
                unit.sentencePatterns.forEach(s => {
                    html += `<div style="padding:2px 0;font-size:13px"><code style="background:#eef;padding:2px 6px;border-radius:4px">${s.pattern || s}</code>`;
                    if (s.usage) html += ` <span style="color:#86868b">â€” ${s.usage}</span>`;
                    html += `</div>`;
                });
                html += `</div>`;
            }

            // Grammar
            if (unit.grammar?.length) {
                html += `<div style="margin-bottom:10px"><strong>ğŸ“ è¯­æ³•:</strong><div class="tag-list" style="margin-top:4px">`;
                unit.grammar.forEach(g => {
                    html += `<span class="tag grammar">${g}</span>`;
                });
                html += `</div></div>`;
            }

            // Commands
            if (unit.commands?.length) {
                html += `<div style="margin-bottom:10px"><strong>ğŸ¯ æŒ‡ä»¤:</strong><div class="tag-list" style="margin-top:4px">`;
                unit.commands.forEach(c => {
                    html += `<span class="tag command">${c}</span>`;
                });
                html += `</div></div>`;
            }

            // Songs
            if (unit.songs?.length) {
                html += `<div style="margin-bottom:10px"><strong>ğŸµ æ­Œæ›²:</strong><div class="tag-list" style="margin-top:4px">`;
                unit.songs.forEach(s => {
                    html += `<span class="tag song">${s.title}${s.firstLine ? ' â€” "' + s.firstLine + '"' : ''}</span>`;
                });
                html += `</div></div>`;
            }

            // Story
            if (unit.storySummary) {
                html += `<div style="margin-bottom:10px"><strong>ğŸ“– æ•…äº‹:</strong>
                    <div style="background:#fff;padding:8px;border-radius:6px;margin-top:4px">
                        ${unit.storyTitle ? '<strong>' + unit.storyTitle + '</strong><br>' : ''}${unit.storySummary}
                    </div></div>`;
            }

            // Also show glossary count
            const glossaryCount = genSelectedDoc.analysis.vocabularyGlossary?.length || 0;
            html += `<div style="border-top:1px solid #e5e5ea;padding-top:8px;margin-top:8px;color:#86868b">
                ğŸ“˜ å…¨ä¹¦è¯æ±‡è¡¨: ${glossaryCount} è¯ï¼ˆç”¨äºç”Ÿæˆå¹²æ‰°é¡¹ï¼‰</div>`;

            el.innerHTML = html;
        }

        function selectBatch(batchIdx) {
            genSelectedBatch = batchIdx;
            document.querySelectorAll('.batch-card').forEach((c, i) => {
                c.classList.toggle('selected', i === batchIdx && !c.classList.contains('done'));
            });
            document.getElementById('generateBtn').disabled = false;
        }

        async function generateQuestions() {
            if (genSelectedBatch === null || !genSelectedDoc || !genSelectedUnit) return;

            const btn = document.getElementById('generateBtn');
            const status = document.getElementById('genStatus');
            const resultCard = document.getElementById('genResultCard');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> AI å‡ºé¢˜ä¸­ï¼ˆçº¦ 30~60 ç§’ï¼‰â€¦';
            status.className = 'status loading';
            status.textContent = `æ­£åœ¨ä¸º Unit ${genSelectedUnit.unitNumber} çš„ Batch ${genSelectedBatch + 1} ç”Ÿæˆé¢˜ç›®â€¦`;

            try {
                const resp = await fetch(`${API}/generate-questions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        docId: genSelectedDoc.id,
                        textbook: genSelectedDoc.textbook,
                        unitNumber: genSelectedUnit.unitNumber,
                        batch: genSelectedBatch
                    })
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || 'ç”Ÿæˆå¤±è´¥');
                }

                const data = await resp.json();
                genPendingQuestions = data.questions;

                // Reset commit UI for the new batch
                document.getElementById('commitBtn').disabled = false;
                document.getElementById('commitBtn').innerHTML = 'âœ… ç¡®è®¤å…¥åº“é¢˜åº“';
                document.getElementById('commitStatus').textContent = '';
                document.getElementById('commitStatus').className = 'status';

                // Mark batch as done
                document.querySelector(`.batch-card[data-batch="${genSelectedBatch}"]`).classList.add('done');
                document.querySelector(`.batch-card[data-batch="${genSelectedBatch}"]`).classList.remove('selected');

                status.className = 'status success';
                status.textContent = `âœ… ç”Ÿæˆå®Œæˆï¼å…± ${data.count} é“é¢˜ã€‚è¯·å®¡æ ¸åç¡®è®¤å…¥åº“ã€‚`;

                // Show results
                showGeneratedQuestions(data.questions);
                resultCard.style.display = 'block';
            } catch (e) {
                status.className = 'status error';
                status.textContent = `âŒ ${e.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ¤– ç”Ÿæˆé¢˜ç›®';
            }
        }

        function showGeneratedQuestions(questions) {
            // Stats
            const typeCount = {};
            questions.forEach(q => {
                const t = q.questionType || 'unknown';
                typeCount[t] = (typeCount[t] || 0) + 1;
            });
            const statsHtml = Object.entries(typeCount).map(([type, count]) =>
                `<div class="stat"><div class="num">${count}</div>${type}</div>`
            ).join('');
            document.getElementById('genStats').innerHTML = statsHtml;

            // JSON preview
            document.getElementById('genJsonPreview').textContent = JSON.stringify(questions, null, 2);

            // Visual question cards
            let cardsHtml = '';
            questions.forEach((q, i) => {
                cardsHtml += renderQuestionCard(q, i);
            });
            document.getElementById('genQuestionCards').innerHTML = cardsHtml;
            updateCommitCount();
            // Reset eval status
            document.getElementById('evalStatus').textContent = '';
            document.getElementById('evalStatus').className = 'status';
        }

        function renderQuestionCard(q, idx) {
            const type = q.questionType || 'unknown';
            const typeColors = {
                vocabulary: '#ff9500', cloze: '#007aff', grammar: '#8b5cf6',
                multipleChoice: '#34c759', errorCorrection: '#ff3b30',
                translation: '#ff9500', rewriting: '#007aff', sentenceOrdering: '#8b5cf6',
                reading: '#34c759', writing: '#ff3b30',
                listening: '#007aff', speaking: '#ff9500'
            };
            const color = typeColors[type] || '#86868b';

            let body = '';
            if (q.stem) body += `<div style="font-weight:600;margin-bottom:4px">${q.stem}</div>`;
            if (q.translation) body += `<div style="color:#86868b;font-size:13px;margin-bottom:6px">${q.translation}</div>`;
            if (q.stemTranslation) body += `<div style="color:#86868b;font-size:13px;margin-bottom:6px">${q.stemTranslation}</div>`;
            if (q.sentence) body += `<div style="font-weight:600;margin-bottom:4px">${q.sentence}</div>`;
            if (q.word) body += `<div style="font-weight:600;margin-bottom:4px">${q.word} ${q.phonetic || ''} â€” ${q.meaning || ''}</div>`;
            if (q.prompt) body += `<div style="font-weight:600;margin-bottom:4px">${q.prompt}</div>`;
            if (q.sourceText) body += `<div style="font-weight:600;margin-bottom:4px">${q.sourceText}</div>`;
            if (q.originalSentence) body += `<div style="font-weight:600;margin-bottom:4px">${q.originalSentence}</div>`;
            if (q.content) body += `<div style="background:#f9f9f9;padding:8px;border-radius:6px;font-size:13px;margin-bottom:6px">${q.content?.substring(0, 200)}â€¦</div>`;
            if (q.transcript) body += `<div style="font-style:italic;font-size:13px;margin-bottom:6px">ğŸ§ ${q.transcript}</div>`;

            // Options
            if (q.options && Array.isArray(q.options)) {
                body += '<div style="margin:6px 0">';
                q.options.forEach((opt, oi) => {
                    const isCorrect = oi === q.correctIndex;
                    body += `<div style="padding:3px 0;font-size:13px;${isCorrect ? 'color:#34c759;font-weight:700' : ''}">${String.fromCharCode(65 + oi)}. ${opt} ${isCorrect ? 'âœ“' : ''}</div>`;
                });
                body += '</div>';
            }

            // Answer
            if (q.answer) body += `<div style="font-size:13px;color:#34c759">ç­”æ¡ˆ: ${q.answer}</div>`;
            if (q.referenceAnswer) body += `<div style="font-size:13px;color:#34c759">å‚è€ƒ: ${q.referenceAnswer}</div>`;
            if (q.referenceText) body += `<div style="font-size:13px;color:#34c759">å‚è€ƒ: ${q.referenceText}</div>`;
            if (q.correction) body += `<div style="font-size:13px;color:#34c759">æ”¹æ­£: ${q.errorRange} â†’ ${q.correction}</div>`;
            if (q.correctSentence) body += `<div style="font-size:13px;color:#34c759">æ­£ç¡®: ${q.correctSentence}</div>`;

            // Explanation
            if (q.explanation) body += `<div style="font-size:12px;color:#86868b;margin-top:4px;border-top:1px solid #f0f0f0;padding-top:4px">ğŸ’¡ ${q.explanation}</div>`;
            if (q.explanationTranslation) body += `<div style="font-size:12px;color:#86868b">${q.explanationTranslation}</div>`;

            // Sub-questions (reading)
            if (q.subQuestions && Array.isArray(q.subQuestions)) {
                q.subQuestions.forEach((sq, si) => {
                    body += `<div style="margin-top:8px;padding:8px;background:#f9f9f9;border-radius:6px;font-size:13px">`;
                    body += `<div style="font-weight:600">Q${si + 1}: ${sq.stem || ''}</div>`;
                    if (sq.options) {
                        sq.options.forEach((opt, oi) => {
                            const isC = oi === sq.correctIndex;
                            body += `<div style="${isC ? 'color:#34c759;font-weight:700' : ''}">${String.fromCharCode(65 + oi)}. ${opt} ${isC ? 'âœ“' : ''}</div>`;
                        });
                    }
                    body += `</div>`;
                });
            }

            return `<div id="qcard-${idx}" style="border:1px solid #e5e5ea;border-radius:10px;padding:14px;margin-bottom:10px;border-left:4px solid ${color};opacity:1;transition:opacity 0.2s">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                        <input type="checkbox" class="q-checkbox" data-idx="${idx}" checked onchange="onQuestionToggle()" style="width:16px;height:16px">
                        <span style="font-size:12px;font-weight:700;color:${color};text-transform:uppercase">#${idx + 1} ${type}${q.category ? ' Â· ' + q.category : ''}</span>
                    </label>
                    <span style="font-size:11px;color:#86868b" id="qeval-${idx}">${q.level || ''}</span>
                </div>
                ${body}
            </div>`;
        }

        function toggleJsonView() {
            const el = document.getElementById('genJsonPreview');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        // â”€â”€ Eval (AI è´¨æ£€) â”€â”€
        async function evalQuestions() {
            if (!genPendingQuestions.length) return;

            const btn = document.getElementById('evalBtn');
            const status = document.getElementById('evalStatus');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> AI è´¨æ£€ä¸­â€¦';
            status.className = 'status loading';
            status.textContent = `æ­£åœ¨å¯¹ ${genPendingQuestions.length} é“é¢˜ç›®è¿›è¡Œè´¨æ£€â€¦`;

            try {
                const resp = await fetch(`${API}/eval-questions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questions: genPendingQuestions })
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || 'è´¨æ£€å¤±è´¥');
                }

                const data = await resp.json();
                status.className = 'status success';
                status.textContent = `âœ… è´¨æ£€å®Œæˆï¼š${data.passed} é€šè¿‡ï¼Œ${data.failed} ä¸é€šè¿‡`;

                // Mark each question card
                data.results.forEach(r => {
                    const card = document.getElementById(`qcard-${r.index}`);
                    const evalLabel = document.getElementById(`qeval-${r.index}`);
                    const checkbox = document.querySelector(`.q-checkbox[data-idx="${r.index}"]`);
                    if (!card) return;

                    if (r.pass) {
                        evalLabel.innerHTML = '<span style="color:#34c759;font-weight:700">âœ… é€šè¿‡</span>';
                    } else {
                        evalLabel.innerHTML = `<span style="color:#ff3b30;font-weight:700">âŒ ä¸é€šè¿‡</span>`;
                        // Add issue details
                        const issueDiv = document.createElement('div');
                        issueDiv.style.cssText = 'background:#fff5f5;border:1px solid #ff3b30;border-radius:6px;padding:8px;margin-top:6px;font-size:12px;color:#ff3b30';
                        issueDiv.innerHTML = r.issues.map(i => `â€¢ ${i}`).join('<br>');
                        card.appendChild(issueDiv);
                        // Uncheck failed questions
                        if (checkbox) {
                            checkbox.checked = false;
                            card.style.opacity = '0.5';
                        }
                    }
                });
                updateCommitCount();
            } catch (e) {
                status.className = 'status error';
                status.textContent = `âŒ ${e.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ” AI è´¨æ£€';
            }
        }

        // â”€â”€ Checkbox controls â”€â”€
        function onQuestionToggle() {
            document.querySelectorAll('.q-checkbox').forEach(cb => {
                const card = document.getElementById(`qcard-${cb.dataset.idx}`);
                if (card) card.style.opacity = cb.checked ? '1' : '0.5';
            });
            updateCommitCount();
        }

        function toggleAllQuestions(checked) {
            document.querySelectorAll('.q-checkbox').forEach(cb => {
                cb.checked = checked;
                const card = document.getElementById(`qcard-${cb.dataset.idx}`);
                if (card) card.style.opacity = checked ? '1' : '0.5';
            });
            updateCommitCount();
        }

        function updateCommitCount() {
            const checked = document.querySelectorAll('.q-checkbox:checked').length;
            const total = document.querySelectorAll('.q-checkbox').length;
            document.getElementById('commitCount').textContent = `å·²é€‰ ${checked}/${total} é“`;
        }

        // â”€â”€ Commit (only checked questions) â”€â”€
        async function commitQuestions() {
            const checkedIdxs = new Set();
            document.querySelectorAll('.q-checkbox:checked').forEach(cb => {
                checkedIdxs.add(parseInt(cb.dataset.idx));
            });
            const selected = genPendingQuestions.filter((_, i) => checkedIdxs.has(i));
            if (!selected.length) {
                alert('æ²¡æœ‰é€‰ä¸­ä»»ä½•é¢˜ç›®');
                return;
            }
            if (!confirm(`ç¡®è®¤å°† ${selected.length} é“é¢˜ç›®å…¥åº“ï¼Ÿ`)) return;

            const btn = document.getElementById('commitBtn');
            const status = document.getElementById('commitStatus');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> å…¥åº“ä¸­â€¦';

            try {
                const resp = await fetch(`${API}/commit-questions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questions: selected })
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || 'å…¥åº“å¤±è´¥');
                }

                const data = await resp.json();
                status.className = 'status success';
                status.textContent = `âœ… å…¥åº“æˆåŠŸï¼å…±å†™å…¥ ${data.committed}/${data.total} é“é¢˜ç›®åˆ° questions å®¹å™¨ã€‚`;

                if (data.errors?.length) {
                    status.textContent += ` âš ï¸ ${data.errors.length} ä¸ªé”™è¯¯ã€‚`;
                }

                genPendingQuestions = [];
                btn.disabled = true;
                btn.innerHTML = 'âœ… å·²å…¥åº“';
            } catch (e) {
                status.className = 'status error';
                status.textContent = `âŒ ${e.message}`;
                btn.disabled = false;
                btn.innerHTML = 'âœ… ç¡®è®¤å…¥åº“é¢˜åº“';
            }
        }

        function discardQuestions() {
            if (!confirm('ç¡®è®¤ä¸¢å¼ƒå½“å‰ç”Ÿæˆçš„é¢˜ç›®ï¼Ÿ')) return;
            genPendingQuestions = [];
            document.getElementById('genResultCard').style.display = 'none';
            document.getElementById('genStatus').className = 'status';
        }

        // ===== Full-book generation =====
        let fullBookCancelled = false;
        const BATCH_LABELS = { VocabCloze: 'è¯æ±‡å¡«ç©º', GrammarMcqError: 'è¯­æ³•é€‰æ‹©/çº é”™', TransRewriteOrder: 'ç¿»è¯‘/æ”¹å†™/æ’åº', ReadingWriting: 'é˜…è¯»/å†™ä½œ', ListeningSpeaking: 'å¬åŠ›/å£è¯­' };

        function fullBookLog(msg) {
            const log = document.getElementById('fullBookLog');
            const line = document.createElement('div');
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            log.appendChild(line);
            log.scrollTop = log.scrollHeight;
        }

        async function generateFullBook() {
            if (!genSelectedDoc) return;
            const units = genSelectedDoc.analysis.units;
            if (!units?.length) { alert('æ— å•å…ƒæ•°æ®'); return; }

            fullBookCancelled = false;
            const totalSteps = units.length * BATCH_NAMES.length;
            let completed = 0;
            let allQuestions = [];
            let errors = [];

            // UI setup
            const progressBar = document.getElementById('fullBookProgressBar');
            const progressText = document.getElementById('fullBookProgressText');
            const progressCount = document.getElementById('fullBookProgressCount');
            const statusEl = document.getElementById('fullBookStatus');
            const log = document.getElementById('fullBookLog');
            log.innerHTML = '';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            progressCount.textContent = `0/${totalSteps}`;
            statusEl.className = 'status';
            statusEl.textContent = '';
            document.getElementById('fullBookStartBtn').disabled = true;
            document.getElementById('fullBookCancelBtn').style.display = 'inline-block';

            fullBookLog(`å¼€å§‹æ•´ä¹¦å‡ºé¢˜ï¼š${genSelectedDoc.displayName}ï¼Œå…± ${units.length} ä¸ªå•å…ƒ Ã— ${BATCH_NAMES.length} æ‰¹æ¬¡ = ${totalSteps} æ­¥`);

            for (const unit of units) {
                if (fullBookCancelled) break;

                for (const batch of BATCH_NAMES) {
                    if (fullBookCancelled) break;

                    const label = BATCH_LABELS[batch] || batch;
                    fullBookLog(`â–¶ Unit ${unit.unitNumber} (${unit.unitTitle || ''}) â€” ${label}â€¦`);

                    try {
                        const resp = await fetch(`${API}/generate-questions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                docId: genSelectedDoc.id,
                                textbook: genSelectedDoc.textbook,
                                unitNumber: unit.unitNumber,
                                batch: batch
                            })
                        });

                        if (!resp.ok) {
                            const err = await resp.json();
                            throw new Error(err.detail || `HTTP ${resp.status}`);
                        }

                        const data = await resp.json();
                        const qs = data.questions || [];
                        allQuestions.push(...qs);
                        fullBookLog(`  âœ… ç”Ÿæˆ ${qs.length} é“ (ç´¯è®¡ ${allQuestions.length})`);
                    } catch (e) {
                        errors.push({ unit: unit.unitNumber, batch, error: e.message });
                        fullBookLog(`  âŒ å¤±è´¥: ${e.message}`);
                    }

                    completed++;
                    const pct = Math.round(completed / totalSteps * 100);
                    progressBar.style.width = pct + '%';
                    progressText.textContent = pct + '%';
                    progressCount.textContent = `${completed}/${totalSteps}`;
                }
            }

            // Finished
            document.getElementById('fullBookStartBtn').disabled = false;
            document.getElementById('fullBookCancelBtn').style.display = 'none';

            if (fullBookCancelled) {
                fullBookLog(`â¹ å·²åœæ­¢ã€‚å·²ç”Ÿæˆ ${allQuestions.length} é“é¢˜ç›®ã€‚`);
                statusEl.className = 'status error';
                statusEl.textContent = `å·²åœæ­¢ï¼Œå½“å‰ ${allQuestions.length} é“é¢˜ç›®å·²æ”¶é›†ã€‚`;
            } else {
                fullBookLog(`ğŸ‰ æ•´ä¹¦å‡ºé¢˜å®Œæˆï¼å…± ${allQuestions.length} é“ï¼Œ${errors.length} ä¸ªé”™è¯¯ã€‚`);
                statusEl.className = 'status success';
                statusEl.textContent = `âœ… å®Œæˆï¼å…± ${allQuestions.length} é“é¢˜ç›®ï¼Œ${errors.length} ä¸ªé”™è¯¯ã€‚`;
            }

            // Show collected questions in review panel
            if (allQuestions.length) {
                genPendingQuestions = allQuestions;
                const resultCard = document.getElementById('genResultCard');
                resultCard.style.display = 'block';
                document.getElementById('genResultCount').textContent = allQuestions.length;
                const container = document.getElementById('genQuestionCards');
                container.innerHTML = '';
                allQuestions.forEach((q, i) => container.appendChild(renderQuestionCard(q, i)));
                document.getElementById('genJsonPreview').textContent = JSON.stringify(allQuestions, null, 2);
                resultCard.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function cancelFullBook() {
            fullBookCancelled = true;
            fullBookLog('â¹ æ­£åœ¨åœæ­¢â€¦');
        }
    </script>
</body>
</html>
