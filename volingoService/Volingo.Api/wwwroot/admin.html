<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volingo æ•™æç®¡ç†åå°</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 24px; }
        h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
        .subtitle { color: #86868b; margin-bottom: 32px; }
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .card h2 {
            font-size: 18px; font-weight: 600; margin-bottom: 16px;
            display: flex; align-items: center; gap: 8px;
        }
        .card h2 .step {
            background: #007aff; color: #fff;
            width: 28px; height: 28px; border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 700;
        }
        label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 14px; }
        select, input[type="file"] {
            width: 100%; padding: 10px 12px;
            border: 1px solid #d2d2d7; border-radius: 8px;
            font-size: 15px; background: #fff; margin-bottom: 12px;
        }
        select:focus { outline: none; border-color: #007aff; box-shadow: 0 0 0 3px rgba(0,122,255,0.15); }
        .row { display: flex; gap: 16px; }
        .row > * { flex: 1; }
        .btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 10px 20px; border: none; border-radius: 8px;
            font-size: 15px; font-weight: 600; cursor: pointer;
            transition: all 0.15s;
        }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-primary { background: #007aff; color: #fff; }
        .btn-primary:hover:not(:disabled) { background: #0062cc; }
        .btn-success { background: #34c759; color: #fff; }
        .btn-success:hover:not(:disabled) { background: #28a745; }
        .btn-danger { background: #ff3b30; color: #fff; }
        .btn-danger:hover:not(:disabled) { background: #d63027; }
        .btn-analyze { background: #8b5cf6; color: #fff; }
        .btn-analyze:hover:not(:disabled) { background: #7c3aed; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .preview-box {
            background: #fafafa; border: 1px solid #e5e5ea; border-radius: 8px;
            padding: 16px; max-height: 500px; overflow-y: auto;
            font-family: "SF Mono", Monaco, monospace; font-size: 13px;
            white-space: pre-wrap; word-break: break-all; display: none;
        }
        .status {
            padding: 12px 16px; border-radius: 8px; margin-top: 12px;
            font-size: 14px; display: none;
        }
        .status.info    { background: #e8f4fd; color: #0a84ff; display: block; }
        .status.success { background: #e8fae8; color: #248a3d; display: block; }
        .status.error   { background: #fde8e8; color: #ff3b30; display: block; }
        .status.loading { background: #fff8e1; color: #ff9500; display: block; }
        .inventory-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .inventory-table th {
            text-align: left; padding: 10px 12px;
            background: #f5f5f7; border-bottom: 2px solid #e5e5ea; font-weight: 600;
        }
        .inventory-table td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; }
        .inventory-table tr:hover td { background: #f5f5f7; }
        .badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 12px; font-weight: 600;
        }
        .badge-done { background: #e8fae8; color: #248a3d; }
        .badge-empty { background: #f0f0f0; color: #86868b; }
        .badge-ai { background: #f3e8ff; color: #8b5cf6; }
        .spinner {
            display: inline-block; width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid #fff; border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .meta { display: flex; gap: 16px; margin-top: 8px; font-size: 13px; color: #86868b; }
        .meta span { display: flex; align-items: center; gap: 4px; }
        /* Modal */
        .modal-overlay {
            display: none; position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;
        }
        .modal-overlay.active { display: flex; justify-content: center; padding: 40px 20px; }
        .modal {
            background: #fff; border-radius: 16px;
            max-width: 860px; width: 100%;
            max-height: calc(100vh - 80px); overflow-y: auto;
            padding: 32px; position: relative;
        }
        .modal-close {
            position: absolute; top: 16px; right: 16px;
            background: #f0f0f0; border: none;
            width: 32px; height: 32px; border-radius: 50%;
            font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-close:hover { background: #e0e0e0; }
        .modal h2 { font-size: 22px; margin-bottom: 20px; }
        .unit-card {
            border: 1px solid #e5e5ea; border-radius: 12px;
            padding: 20px; margin-bottom: 16px;
        }
        .unit-card h3 { font-size: 16px; font-weight: 700; margin-bottom: 12px; color: #007aff; }
        .unit-section { margin-bottom: 12px; }
        .unit-section h4 {
            font-size: 13px; font-weight: 700; color: #86868b;
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;
        }
        .tag-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag {
            display: inline-block; padding: 3px 10px; border-radius: 12px;
            font-size: 13px; background: #e8f4fd; color: #0a84ff;
        }
        .tag.vocab { background: #fff3e0; color: #ff9500; }
        .tag.grammar { background: #f3e8ff; color: #8b5cf6; }
        .tag.command { background: #e8fae8; color: #248a3d; }
        .tag.song { background: #fde8e8; color: #ff3b30; }
        .sentence-item {
            padding: 4px 0; font-size: 14px; border-bottom: 1px solid #f5f5f5;
        }
        .sentence-item:last-child { border-bottom: none; }
        .sentence-pattern { font-weight: 600; color: #1d1d1f; }
        .sentence-usage { color: #86868b; font-size: 13px; margin-left: 8px; }
        .story-box {
            background: #fafafa; border-radius: 8px; padding: 12px;
            font-size: 14px; color: #333;
        }
        /* Glossary table */
        .glossary-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 8px; }
        .glossary-table th {
            text-align: left; padding: 6px 8px; background: #f5f5f7;
            border-bottom: 2px solid #e5e5ea; font-size: 12px; font-weight: 600;
        }
        .glossary-table td { padding: 4px 8px; border-bottom: 1px solid #f0f0f0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š Volingo æ•™æç®¡ç†åå°</h1>
        <p class="subtitle">é€‰æ‹©æ•™æ â†’ ä¸Šä¼  PDF â†’ Azure Doc Intelligence æå– â†’ Cosmos DB å­˜å‚¨ â†’ GPT-4o æ™ºèƒ½åˆ†æ</p>

        <!-- Step 1: Select textbook -->
        <div class="card">
            <h2><span class="step">1</span> é€‰æ‹©æ•™æ</h2>
            <div class="row">
                <div>
                    <label>æ•™æç‰ˆæœ¬</label>
                    <select id="seriesSelect" onchange="onSeriesChange()">
                        <option value="">â€” é€‰æ‹©æ•™æç‰ˆæœ¬ â€”</option>
                    </select>
                </div>
                <div>
                    <label>å†Œæ¬¡</label>
                    <select id="volumeSelect" disabled>
                        <option value="">â€” å…ˆé€‰æ•™æç‰ˆæœ¬ â€”</option>
                    </select>
                </div>
            </div>
            <div class="meta" id="selectionMeta" style="display:none">
                <span>ğŸ“ ID: <strong id="previewId"></strong></span>
                <span>ğŸ“– <span id="previewDisplay"></span></span>
            </div>
        </div>

        <!-- Step 2: Upload PDF -->
        <div class="card">
            <h2><span class="step">2</span> ä¸Šä¼  PDF å¹¶æå–</h2>
            <input type="file" id="pdfFile" accept=".pdf">
            <button class="btn btn-primary" id="extractBtn" onclick="extractPdf()" disabled>
                ğŸ” æå–æ–‡æœ¬
            </button>
            <div class="status" id="extractStatus"></div>
        </div>

        <!-- Step 3: Preview -->
        <div class="card" id="previewCard" style="display:none">
            <h2><span class="step">3</span> é¢„è§ˆæå–ç»“æœ</h2>
            <div class="meta" id="extractMeta">
                <span>ğŸ“„ é¡µæ•°: <strong id="metaPages">0</strong></span>
                <span>ğŸ“ å­—ç¬¦: <strong id="metaChars">0</strong></span>
            </div>
            <div class="preview-box" id="previewContent" style="display:block; margin-top:12px"></div>
            <div style="margin-top: 16px; display: flex; gap: 12px;">
                <button class="btn btn-success" id="saveBtn" onclick="saveToDb()">
                    âœ… ç¡®è®¤å­˜å…¥ Cosmos DB
                </button>
                <button class="btn btn-danger" onclick="clearPreview()">
                    âŒ æ”¾å¼ƒ
                </button>
            </div>
            <div class="status" id="saveStatus"></div>
        </div>

        <!-- Inventory -->
        <div class="card">
            <h2>ğŸ“Š å·²å…¥åº“æ–‡æ¡£</h2>
            <button class="btn btn-primary btn-sm" onclick="loadInventory()" style="margin-bottom: 12px;">
                ğŸ”„ åˆ·æ–°
            </button>
            <div id="inventoryContent">
                <p style="color: #86868b; font-size: 14px;">ç‚¹å‡»åˆ·æ–°æŸ¥çœ‹å·²å…¥åº“æ–‡æ¡£</p>
            </div>
        </div>

        <!-- Analysis Modal -->
        <div class="modal-overlay" id="analysisModal">
            <div class="modal">
                <button class="modal-close" onclick="closeAnalysisModal()">âœ•</button>
                <h2 id="modalTitle">ğŸ“– çŸ¥è¯†ç‚¹åˆ†æ</h2>
                <div id="modalContent"></div>
            </div>
        </div>
    </div>

    <script>
        const API = "/api/v1/admin";
        let textbooks = [];
        let extractedContent = "";
        let extractedPages = 0;

        // â”€â”€ Init â”€â”€
        async function init() {
            const resp = await fetch(`${API}/textbooks`);
            textbooks = await resp.json();
            const sel = document.getElementById("seriesSelect");

            const groups = {};
            textbooks.forEach(t => {
                const parts = t.displayName.split("Â·");
                const group = parts.length > 1 ? parts[0] : "å…¶ä»–";
                if (!groups[group]) groups[group] = [];
                groups[group].push(t);
            });

            for (const [group, items] of Object.entries(groups)) {
                const optgroup = document.createElement("optgroup");
                optgroup.label = group;
                items.forEach(t => {
                    const opt = document.createElement("option");
                    opt.value = t.seriesCode;
                    opt.textContent = t.displayName;
                    optgroup.appendChild(opt);
                });
                sel.appendChild(optgroup);
            }

            // Auto-refresh inventory on page load
            loadInventory();
        }

        async function onSeriesChange() {
            const code = document.getElementById("seriesSelect").value;
            const volSel = document.getElementById("volumeSelect");
            volSel.innerHTML = "";

            if (!code) {
                volSel.disabled = true;
                volSel.innerHTML = '<option value="">â€” å…ˆé€‰æ•™æç‰ˆæœ¬ â€”</option>';
                updatePreviewId();
                return;
            }

            const tb = textbooks.find(t => t.seriesCode === code);
            if (!tb.isGradeSync) {
                volSel.disabled = true;
                volSel.innerHTML = '<option value="">ï¼ˆæ— éœ€é€‰æ‹©å†Œæ¬¡ï¼‰</option>';
                updatePreviewId();
                updateExtractBtn();
                return;
            }

            const resp = await fetch(`${API}/textbooks/${code}/volumes`);
            const volumes = await resp.json();

            volSel.disabled = false;
            volSel.innerHTML = '<option value="">â€” é€‰æ‹©å†Œæ¬¡ â€”</option>';
            volumes.forEach(v => {
                const opt = document.createElement("option");
                opt.value = v.volume;
                opt.textContent = v.display;
                volSel.appendChild(opt);
            });

            volSel.onchange = () => { updatePreviewId(); updateExtractBtn(); };
            updatePreviewId();
            updateExtractBtn();
        }

        function updatePreviewId() {
            const code = document.getElementById("seriesSelect").value;
            const vol = document.getElementById("volumeSelect").value;
            const meta = document.getElementById("selectionMeta");

            if (!code) { meta.style.display = "none"; return; }

            const tb = textbooks.find(t => t.seriesCode === code);
            let id = code;
            if (tb.isGradeSync && vol) {
                id = `${code}-${vol}`;
            } else if (tb.isGradeSync && !vol) {
                meta.style.display = "none";
                return;
            }

            document.getElementById("previewId").textContent = id;
            document.getElementById("previewDisplay").textContent =
                tb.displayName + (vol ? ` Â· ${document.getElementById("volumeSelect").selectedOptions[0]?.text || ""}` : "");
            meta.style.display = "flex";
        }

        function updateExtractBtn() {
            const code = document.getElementById("seriesSelect").value;
            const vol = document.getElementById("volumeSelect").value;
            const file = document.getElementById("pdfFile").files[0];
            const tb = textbooks.find(t => t.seriesCode === code);
            const ready = code && file && (!tb?.isGradeSync || vol);
            document.getElementById("extractBtn").disabled = !ready;
        }

        document.getElementById("pdfFile").addEventListener("change", updateExtractBtn);

        // â”€â”€ Extract â”€â”€
        async function extractPdf() {
            const file = document.getElementById("pdfFile").files[0];
            if (!file) return;

            const btn = document.getElementById("extractBtn");
            const status = document.getElementById("extractStatus");

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> æå–ä¸­â€¦';
            status.className = "status loading";
            status.textContent = `æ­£åœ¨ä¸Šä¼  ${file.name} (${(file.size / 1024 / 1024).toFixed(1)} MB) å¹¶è°ƒç”¨ Azure Doc Intelligenceâ€¦`;

            const formData = new FormData();
            formData.append("file", file);

            try {
                const resp = await fetch(`${API}/extract`, { method: "POST", body: formData });
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || "æå–å¤±è´¥");
                }
                const data = await resp.json();

                extractedContent = data.content;
                extractedPages = data.totalPages;

                document.getElementById("previewCard").style.display = "block";
                document.getElementById("previewContent").textContent = data.content;
                document.getElementById("metaPages").textContent = data.totalPages;
                document.getElementById("metaChars").textContent = data.charCount.toLocaleString();

                status.className = "status success";
                status.textContent = `âœ… æå–å®Œæˆ: ${data.totalPages} é¡µ, ${data.charCount.toLocaleString()} å­—ç¬¦`;
            } catch (e) {
                status.className = "status error";
                status.textContent = `âŒ ${e.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = "ğŸ” æå–æ–‡æœ¬";
                updateExtractBtn();
            }
        }

        // â”€â”€ Save â”€â”€
        async function saveToDb() {
            const code = document.getElementById("seriesSelect").value;
            const vol = document.getElementById("volumeSelect").value;
            const btn = document.getElementById("saveBtn");
            const status = document.getElementById("saveStatus");

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> ä¿å­˜ä¸­â€¦';

            try {
                const resp = await fetch(`${API}/save`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        seriesCode: code,
                        volume: vol || null,
                        rawContent: extractedContent,
                        totalPages: extractedPages,
                    }),
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || "ä¿å­˜å¤±è´¥");
                }
                const data = await resp.json();

                status.className = "status success";
                status.textContent = `âœ… å·²ä¿å­˜: ${data.id} (${data.displayName}), ${data.totalPages} é¡µ, ${data.charCount.toLocaleString()} å­—ç¬¦`;
                loadInventory();
            } catch (e) {
                status.className = "status error";
                status.textContent = `âŒ ${e.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = "âœ… ç¡®è®¤å­˜å…¥ Cosmos DB";
            }
        }

        function clearPreview() {
            document.getElementById("previewCard").style.display = "none";
            extractedContent = "";
            extractedPages = 0;
        }

        // â”€â”€ Inventory â”€â”€
        async function loadInventory() {
            const container = document.getElementById("inventoryContent");
            container.innerHTML = '<p style="color: #86868b;">åŠ è½½ä¸­â€¦</p>';

            try {
                const resp = await fetch(`${API}/documents`);
                const docs = await resp.json();

                if (docs.length === 0) {
                    container.innerHTML = '<p style="color: #86868b;">æš‚æ— å·²å…¥åº“æ–‡æ¡£</p>';
                    return;
                }

                let html = `<table class="inventory-table">
                    <thead><tr>
                        <th>ID</th><th>æ•™æ</th><th>å†Œæ¬¡</th><th>é¡µæ•°</th><th>AI åˆ†æ</th><th>æ›´æ–°æ—¶é—´</th><th>æ“ä½œ</th>
                    </tr></thead><tbody>`;

                docs.sort((a, b) => a.id.localeCompare(b.id));
                docs.forEach(doc => {
                    const updated = doc.updatedAt ? new Date(doc.updatedAt).toLocaleString("zh-CN") : "-";
                    const hasAI = doc.hasAnalysis;
                    const aiBadge = hasAI
                        ? '<span class="badge badge-ai">âœ… å·²åˆ†æ</span>'
                        : '<span class="badge badge-empty">æœªåˆ†æ</span>';
                    html += `<tr>
                        <td><code>${doc.id}</code></td>
                        <td>${doc.displayName || doc.textbook}</td>
                        <td>${doc.volume || "-"}</td>
                        <td>${doc.totalPages || 0}</td>
                        <td>${aiBadge}</td>
                        <td>${updated}</td>
                        <td style="display:flex;gap:6px;flex-wrap:wrap;">
                            <button class="btn btn-analyze btn-sm" onclick="analyzeDoc('${doc.id}','${doc.textbook}', this)">
                                ğŸ¤– ${hasAI ? 'é‡æ–°åˆ†æ' : 'AI åˆ†æ'}
                            </button>
                            ${hasAI ? `<button class="btn btn-primary btn-sm" onclick="viewAnalysis('${doc.id}','${doc.textbook}')">ğŸ“– æŸ¥çœ‹</button>` : ''}
                            <button class="btn btn-danger btn-sm" onclick="deleteDoc('${doc.id}','${doc.textbook}')">åˆ é™¤</button>
                        </td>
                    </tr>`;
                });
                html += "</tbody></table>";
                html += `<p style="color: #86868b; margin-top:8px; font-size:13px;">å…± ${docs.length} æ¡è®°å½•</p>`;
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = `<p style="color: #ff3b30;">åŠ è½½å¤±è´¥: ${e.message}</p>`;
            }
        }

        async function deleteDoc(id, textbook) {
            if (!confirm(`ç¡®è®¤åˆ é™¤ ${id}ï¼Ÿ`)) return;
            try {
                const resp = await fetch(`${API}/documents/${id}?textbook=${encodeURIComponent(textbook)}`, { method: "DELETE" });
                if (resp.ok) loadInventory();
            } catch (e) {
                alert("åˆ é™¤å¤±è´¥: " + e.message);
            }
        }

        // â”€â”€ AI Analysis â”€â”€
        async function analyzeDoc(id, textbook, btn) {
            if (!confirm(`å¯¹ ${id} è¿è¡Œ GPT-4o åˆ†æï¼Ÿ\nï¼ˆå¯èƒ½éœ€è¦ 30-60 ç§’ï¼‰`)) return;

            const origText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="border-top-color:#fff"></span> åˆ†æä¸­â€¦';

            try {
                const resp = await fetch(`${API}/analyze/${id}?textbook=${encodeURIComponent(textbook)}`, {
                    method: "POST",
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || "åˆ†æå¤±è´¥");
                }
                const data = await resp.json();
                alert(`âœ… åˆ†æå®Œæˆï¼å…±æå– ${data.unitCount} ä¸ªå•å…ƒçš„çŸ¥è¯†ç‚¹ã€‚`);
                loadInventory();
                showAnalysis(data.analysis, data.displayName);
            } catch (e) {
                alert(`âŒ åˆ†æå¤±è´¥: ${e.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = origText;
            }
        }

        async function viewAnalysis(id, textbook) {
            try {
                const resp = await fetch(`${API}/documents/${id}/analysis?textbook=${encodeURIComponent(textbook)}`);
                const data = await resp.json();
                if (!data.hasAnalysis) {
                    alert("è¯¥æ–‡æ¡£å°šæœªè¿›è¡Œ AI åˆ†æ");
                    return;
                }
                showAnalysis(data.analysis, data.displayName);
            } catch (e) {
                alert("åŠ è½½åˆ†æç»“æœå¤±è´¥: " + e.message);
            }
        }

        function showAnalysis(analysis, displayName) {
            const modal = document.getElementById("analysisModal");
            const title = document.getElementById("modalTitle");
            const content = document.getElementById("modalContent");

            title.textContent = `ğŸ“– ${displayName} â€” çŸ¥è¯†ç‚¹åˆ†æ`;

            let html = "";

            // Book info
            const info = analysis.bookInfo;
            if (info) {
                html += `<div style="margin-bottom:20px;padding:12px;background:#f5f5f7;border-radius:8px;font-size:14px;">
                    <strong>${info.title || ""}</strong><br>
                    å‡ºç‰ˆç¤¾: ${info.publisher || ""} Â· ${info.grade || ""}${info.semester || ""}
                    ${info.startingPoint ? ` Â· ${info.startingPoint}` : ""}
                    ${info.characters?.length ? `<br>è§’è‰²: ${info.characters.join(", ")}` : ""}
                </div>`;
            }

            // Units
            const units = analysis.units || [];
            units.forEach(unit => {
                html += `<div class="unit-card">`;
                html += `<h3>${unit.unitNumber === 0 ? "Starter" : `Unit ${unit.unitNumber}`}: ${unit.unitTitle || ""}</h3>`;
                if (unit.topic) {
                    html += `<div style="color:#86868b;font-size:14px;margin-bottom:12px;">ä¸»é¢˜: ${unit.topic}</div>`;
                }

                // Vocabulary
                if (unit.vocabulary?.length) {
                    html += `<div class="unit-section"><h4>ğŸ“ ç”Ÿè¯ (${unit.vocabulary.length})</h4><div class="tag-list">`;
                    unit.vocabulary.forEach(v => {
                        html += `<span class="tag vocab" title="${v.type || ''}">${v.word} <small>${v.meaning}</small></span>`;
                    });
                    html += `</div></div>`;
                }

                // Sentence patterns
                if (unit.sentencePatterns?.length) {
                    html += `<div class="unit-section"><h4>ğŸ’¬ æ ¸å¿ƒå¥å‹</h4>`;
                    unit.sentencePatterns.forEach(s => {
                        html += `<div class="sentence-item">
                            <span class="sentence-pattern">${s.pattern || s}</span>
                            ${s.usage ? `<span class="sentence-usage">â€” ${s.usage}</span>` : ""}
                        </div>`;
                    });
                    html += `</div>`;
                }

                // Grammar
                if (unit.grammar?.length) {
                    html += `<div class="unit-section"><h4>ğŸ“ è¯­æ³•è¦ç‚¹</h4><div class="tag-list">`;
                    unit.grammar.forEach(g => {
                        html += `<span class="tag grammar">${g}</span>`;
                    });
                    html += `</div></div>`;
                }

                // Songs
                if (unit.songs?.length) {
                    html += `<div class="unit-section"><h4>ğŸµ æ­Œæ›²/æ­Œè°£</h4><div class="tag-list">`;
                    unit.songs.forEach(s => {
                        html += `<span class="tag song">${s.type === "song" ? "ğŸ¶" : "ğŸ—£ï¸"} ${s.title}${s.firstLine ? ` â€” "${s.firstLine}"` : ""}</span>`;
                    });
                    html += `</div></div>`;
                }

                // Commands
                if (unit.commands?.length) {
                    html += `<div class="unit-section"><h4>ğŸ¯ è¯¾å ‚æŒ‡ä»¤</h4><div class="tag-list">`;
                    unit.commands.forEach(c => {
                        html += `<span class="tag command">${c}</span>`;
                    });
                    html += `</div></div>`;
                }

                // Story
                if (unit.storySummary) {
                    html += `<div class="unit-section"><h4>ğŸ“– Story Time</h4>
                        <div class="story-box">${unit.storyTitle ? `<strong>${unit.storyTitle}</strong><br>` : ""}${unit.storySummary}</div>
                    </div>`;
                }

                html += `</div>`;
            });

            // Vocabulary Glossary
            const glossary = analysis.vocabularyGlossary || [];
            if (glossary.length) {
                html += `<div class="unit-card">
                    <h3>ğŸ“˜ è¯æ±‡æ€»è¡¨ (${glossary.length} è¯)</h3>
                    <table class="glossary-table">
                    <thead><tr><th>å•è¯</th><th>é‡Šä¹‰</th><th>è¯æ€§</th><th>é¦–ç°å•å…ƒ</th></tr></thead>
                    <tbody>`;
                glossary.forEach(g => {
                    html += `<tr><td><strong>${g.word}</strong></td><td>${g.meaning}</td><td>${g.type || ""}</td><td>${g.unitFirst ?? ""}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            }

            content.innerHTML = html;
            modal.classList.add("active");
            document.body.style.overflow = "hidden";
        }

        function closeAnalysisModal() {
            document.getElementById("analysisModal").classList.remove("active");
            document.body.style.overflow = "";
        }
        document.getElementById("analysisModal").addEventListener("click", (e) => {
            if (e.target === e.currentTarget) closeAnalysisModal();
        });

        // Init
        init();
    </script>
</body>
</html>
